################################################################################
##                                                                            ##
##                      Problem Set 1                                         ##
##                    GEIH 2018 - Bogotá                                      ##
##                                                                            ##
##          Big Data and Machine Learning para Economía Aplicada              ##
##          MECA 4107 - Universidad de los Andes                              ##
##          Integrantes:                                                      ##
##          - Jose Alejandro Rincon                                           ## 
##          - Juan Camilo Riano                                               ##
##          - Lucas Rodriguez                                                 ##
##          - Martin Santiago Gonzalez                                        ##
##                                                                            ##
################################################################################

## Descripción:
##   Este es el script maestro que reproduce todos los resultados del 
##   Problem Set 1. Ejecutar este único archivo genera todas las figuras,
##   tablas y outputs del proyecto para que se pueda replicar.

################################################################################

# ==============================================================================
# CONFIGURACIÓN INICIAL
# ==============================================================================

rm(list = ls())
set.seed(6666)

# Paquetes
require(pacman)
p_load(tidyverse, boot, stargazer, ggplot2, scales, gridExtra, knitr, kableExtra, rvest, httr,here,modelsummary)

# Tema para gráficos
theme_set(theme_minimal(base_size = 12))


# Creación de carpetas para cada punto

setwd(here())
dir.create("01_Section_1_Age_Labor_Income_Profile", showWarnings = FALSE)
dir.create("02_Section_2_Gender_Labor_Income_Gap", showWarnings = FALSE)
dir.create("03_Section_3_Predicting_Income", showWarnings = FALSE)

# Colores
col_primary <- "#1E3A5F"
col_secondary <- "#C41E3A"
col_accent <- "#4A90A4"

cat("Iniciando reproducción de resultados\n")
cat("Fecha:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n\n")


################################################################################
##                                                                            ##
##                    SECTION 1: AGE-LABOR INCOME PROFILE                     ##
##                                                                            ##
################################################################################

cat("\n")
cat("################################################################################\n")
cat("##                                                                            ##\n")
cat("##                    SECTION 1: AGE-LABOR INCOME PROFILE                     ##\n")
cat("##                                                                            ##\n")
cat("################################################################################\n")
cat("\n")

# Working directory

here()
setwd(here("01_Section_1_Age_Labor_Income_Profile"))

# Crear carpetas
dir.create("01_code", showWarnings = FALSE)
dir.create("02_output", showWarnings = FALSE)
dir.create("02_output/tables", showWarnings = FALSE)
dir.create("02_output/figures", showWarnings = FALSE)

# ==============================================================================
# 1.1: CARGA Y PREPARACIÓN DE DATOS (PARA TODAS LAS SECCIONES)
# ==============================================================================

cat("========================================================================\n")
cat("  1.1 Web Scraping - GEIH 2018                                         \n")
cat("========================================================================\n")
cat("\n")

source("01_code/01_S1_data_scraping.R")

# ==============================================================================
# 1.2 LIMPIEZA Y CONSTRUCCION DE MUESTRA
# ==============================================================================

cat("========================================================================\n")
cat("  1.2 Limpieza y Construccion de Muestra                               \n")
cat("========================================================================\n")
cat("\n")

source("01_code/02_S1_data_cleaning_workers.R")

# ==============================================================================
# 1.3 ESTADISTICAS DESCRIPTIVAS
# ==============================================================================

cat("========================================================================\n")
cat("  1.3 Estadisticas Descriptivas                                        \n")
cat("========================================================================\n")
cat("\n")

source("01_code/03_S1_age_analysis_descriptive_stats.R")

# ==============================================================================
# 1.4 ESTIMACION PERFIL EDAD-INGRESO
# ==============================================================================

cat("========================================================================\n")
cat("  1.4 Estimacion Perfil Edad-Ingreso                                   \n")
cat("========================================================================\n")
cat("\n")

source("01_code/04_S1_age_income_models.R")

# ==============================================================================
# 1.5 VISUALIZACION DE MODELOS
# ==============================================================================

cat("========================================================================\n")
cat("  1.5 Visualizacion de Modelos                                         \n")
cat("========================================================================\n")
cat("\n")

source("01_code/05_S1_age_income_models_visualization.R")

# ==============================================================================
# 1.6 RESUMEN DE RESULTADOS
# ==============================================================================

cat("========================================================================\n")
cat("  1.6 Resumen de Resultados                                            \n")
cat("========================================================================\n")
cat("\n")

source("01_code/06_S1_age_model_results_sum.R")

################################################################################
##                                                                            ##
##                    SECTION 2: GENDER WAGE GAP                              ##
##                                                                            ##
################################################################################

cat("\n")
cat("################################################################################\n")
cat("##                                                                            ##\n")
cat("##                    SECTION 2: GENDER WAGE GAP                              ##\n")
cat("##                                                                            ##\n")
cat("################################################################################\n")
cat("\n")

# Working directory
setwd(here("02_Section_2_Gender_Labor_Income_Gap"))

# Crear subcarpetas
dir.create("01_code", showWarnings = FALSE)
dir.create("02_output", showWarnings = FALSE)
dir.create("02_output/tables", showWarnings = FALSE)
dir.create("02_output/figures", showWarnings = FALSE)

# ==============================================================================
# 2.1 ESTADISTICAS DESCRIPTIVAS POR GENERO
# ==============================================================================

cat("========================================================================\n")
cat("  2.1 Estadisticas Descriptivas por Genero                             \n")
cat("========================================================================\n")
cat("\n")

source("01_code/01_s2_Descriptive_Statistics.R")

# ==============================================================================
# 2.2 MODELO INCONDICIONAL
# ==============================================================================

cat("========================================================================\n")
cat("  2.2 Modelo Incondicional                                             \n")
cat("========================================================================\n")
cat("\n")

source("01_code/02_s2_Unconditional_Model.R")

# ==============================================================================
# 2.3 MODELO CONDICIONAL - FWL
# ==============================================================================

cat("========================================================================\n")
cat("  2.3 Modelo Condicional - Frisch-Waugh-Lovell                         \n")
cat("========================================================================\n")
cat("\n")

source("01_code/03_s2_FWL_Model.R")

# ==============================================================================
# 2.4 BOOTSTRAP ERRORES ESTANDAR
# ==============================================================================

cat("========================================================================\n")
cat("  2.4 Bootstrap para Errores Estandar                                  \n")
cat("========================================================================\n")
cat("\n")

source("01_code/04_s2_FWL_SE_Bootstrap.R")


# ==============================================================================
# 2.5 PRESENTACION DE RESULTADOS
# ==============================================================================

cat("========================================================================\n")
cat("  2.5 Presentacion de Resultados                                       \n")
cat("========================================================================\n")
cat("\n")

source("01_code/05_s2_FWL_Presentacion_Resultados.R")

# ==============================================================================
# 2.6 DIFERENCIA DE EDADES PICO POR GENERO
# ==============================================================================

cat("========================================================================\n")
cat("  2.6 Diferencia de Edades Pico por Genero                             \n")
cat("========================================================================\n")
cat("\n")

source("01_code/06_s2_Diferencia_Edades.R")

################################################################################
##                                                                            ##
##                    SECTION 3: PREDICTING INCOME                            ##
##                                                                            ##
################################################################################

cat("\n")
cat("################################################################################\n")
cat("##                                                                            ##\n")
cat("##                    SECTION 3: PREDICTING INCOME                            ##\n")
cat("##                                                                            ##\n")
cat("################################################################################\n")
cat("\n")

# Working directory
setwd(here("03_Section_3_Predicting_Income"))

# Crear subcarpetas
dir.create("01_code", showWarnings = FALSE)
dir.create("02_output", showWarnings = FALSE)
dir.create("02_output/tables", showWarnings = FALSE)
dir.create("02_output/figures", showWarnings = FALSE)

# ==============================================================================
# 3.1 DIVISION TRAINING / TESTING
# ==============================================================================

cat("========================================================================\n")
cat("  3.1 Division de Datos: Training / Testing                            \n")
cat("========================================================================\n")
cat("\n")

source("01_code/01_S3_Train_Test_Split.R")

# ==============================================================================
# 3.2 MODELOS BASELINE (SECCIONES 1 Y 2)
# ==============================================================================

cat("========================================================================\n")
cat("  3.2 Modelos Baseline (Secciones 1 y 2)                               \n")
cat("========================================================================\n")
cat("\n")

source("01_code/02_S3_Baseline_Models.R")

# ==============================================================================
# 3.3 NUEVAS ESPECIFICACIONES
# ==============================================================================

cat("========================================================================\n")
cat("  3.3 Nuevas Especificaciones (5+)                                     \n")
cat("========================================================================\n")
cat("\n")

source("01_code/03_S3_Extended_Models.R")

# ==============================================================================
# 3.4 SELECCION DEL MEJOR MODELO
# ==============================================================================

cat("========================================================================\n")
cat("  3.4 Seleccion del Mejor Modelo (RMSE)                                \n")
cat("========================================================================\n")
cat("\n")

source("01_code/04_S3_Model_Selection.R")

# ==============================================================================
# 3.5 LOOCV ERROR
# ==============================================================================

cat("========================================================================\n")
cat("  3.5 Leave-One-Out Cross-Validation Error                             \n")
cat("========================================================================\n")
cat("\n")

source("01_code/05_S3_LOOCV_Error.R")


# ==============================================================================
# 3.6 ANALISIS DE INFLUENCIA Y LEVERAGE
# ==============================================================================

cat("========================================================================\n")
cat("  3.6 Analisis de Influencia y Leverage (FWL)                          \n")
cat("========================================================================\n")
cat("\n")

source("01_code/06_S3_Leverage_Analysis.R")

# ==============================================================================
# 3.7 ANALISIS DE ERRORES DE PREDICCION
# ==============================================================================

cat("========================================================================\n")
cat("  3.7 Analisis de Errores de Prediccion                                \n")
cat("========================================================================\n")
cat("\n")

source("01_code/07_S3_Prediction_Errors.R")

cat("################################################################################\n")
cat("##                         FIN DEL SCRIPT MAESTRO                            ##\n")
cat("################################################################################\n")
cat("\n")


